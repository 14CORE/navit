machine:
  environment:
  lat: 37.559892
  lng: -119.933931
  dlat: 37.533591
  dlng: -119.920106
dependencies:
  cache_directories:
    - ~/.android
    - ~/android
    - "~/assets/"
  pre:
    - "[ -d ~/assets ] || mkdir ~/assets"
    - "[ -d ~/android ] || mkdir ~/android"
    - wget -c -O ~/assets/cov-analysis-linux64-7.6.0.tar.gz http://sd-55475.dedibox.fr/cov-analysis-linux64-7.6.0.tar.gz
    - sudo apt-get install cmake
    - sudo apt-get install libpng12-dev 
    - sudo apt-get install libgtk2.0-dev 
    - sudo apt-get install librsvg2-bin 
    - sudo apt-get install libfreetype6-dev
    - sudo apt-get install libdbus-glib-1-dev
    - sudo apt-get install g++
    - wget "http://download.geofabrik.de/north-america/us/california-latest.osm.pbf" -O ~/california-latest.osm.pbf
    - bash ci/build.sh
test:
  post:
    - bin/navit/maptool/maptool -P  -6 -i ~/california-latest.osm.pbf $CIRCLE_ARTIFACTS/california.bin:
        timeout: 7200
    - sed -i -e 's@name="Local GPS" profilename="car" enabled="yes" active="1"@name="Local GPS" profilename="car" enabled="no" active="0"@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@name="Demo" profilename="car" enabled="no" active="yes"@name="Demo" profilename="car" enabled="yes" active="yes" follow="1" refresh="1"@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@type="internal" enabled@type="internal" fullscreen="1" font_size="350" enabled@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@libbinding_dbus.so" active="no"@libbinding_dbus.so" active="yes"@' navit.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/california.bin" />' > maps/california.xml:
        pwd: bin/navit/
    - ./navit:
        pwd: bin/navit/
        background: true
    - sleep 5
    - >
      dbus-send --print-reply --session --dest=org.navit_project.navit /org/navit_project/navit/default_navit org.navit_project.navit.navit.set_position string:"geo: $lng $lat";
    - import -window root $CIRCLE_ARTIFACTS/position.png
    - >
      dbus-send --print-reply --session --dest=org.navit_project.navit /org/navit_project/navit/default_navit org.navit_project.navit.navit.set_destination string:"geo: $dlng $dlat" string:"dbus";

    - sleep 5
    - import -window root $CIRCLE_ARTIFACTS/default.png
    - dbus-send  --print-reply --session --dest=org.navit_project.navit /org/navit_project/navit/default_navit org.navit_project.navit.navit.quit
